<!DOCTYPE html>
<html lang="en-gb">
  <head>
    <title>Waveform Visualizer</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="application-name" content="Waveform Visualizer" />
    <meta name="theme-color" content="#171717">
    <link rel="manifest" href="manifest.json">
    <style>
	* {
	  background: #171717;
	  overflow: hidden;
	}
	.center {
	  margin: 0;
	  position: absolute;
	  top: 50%;
	  left: 50%;
	  -ms-transform: translate(-50%, -50%);
	  transform: translate(-50%, -50%);
	}

	svg polyline,
	svg line,
	svg path {
	  fill: none;
	  stroke: white;
	  stroke-linecap: round;
	  stroke-linejoin: round;
	  transition: 1s;
	}
  </style>
</head>
<body>

<svg viewBox="0 0 600 600" class="center">
  <path id="path" d="" />
</svg>

<script>
Math.random.between = (min, max) => Math.floor(Math.random()*(max-min+1)+min);

const $path = document.getElementById('path');

const newRandomWave = (span = 25) => ({
  amplitude: Math.random.between(span * -1, span) || 1,
  frequency: Math.random.between(span * -1, span) || 1,
});

const size = 600;
const center = size * 0.5;
const radius = size * 0.25;
const changeTime = 1000;

const Point = ({ x, y }) => ({ x, y, set({ x ,y }) {
	this.x = x;
  this.y = y;
}})

const f = (i) => ({
  amplitude,
  frequency
}) => amplitude * Math.sin(frequency * i);

const calculatePoints = (waves) => {
  const newPoints = [];
  for (let i = 0; i < Math.PI * 2; i += 0.001) {
    const x = Math.cos(i);
    const y = Math.sin(i);
    const r = radius + waves.map(f(i)).reduce((sum, v) => sum + v, 0);
    newPoints.push(Point({ 
    	x: center + x * r, 
      y: center + y * r,
    }));
  }
  return newPoints;
}

const generatePointsToPickFrom = () => {
  console.log('Generating points to pick from');
  return Array(10).fill(0)
    .map(() => {
    const waves = Array(3).fill(25).map(newRandomWave);
      const points = calculatePoints(waves);
      return points;
    });
};

let pointsToPickFrom = generatePointsToPickFrom();
  
let pointsToUse = calculatePoints([{
  amplitude: 1,
  frequency: 1,
}]);

const drawFrame = (frameNumber) => () => {
	let path = '';
  for (let i = 0; i < pointsToUse.length; i += 2) {
  	const start = pointsToUse[i];
  	const pivot = pointsToUse[i+1] || pointsToUse[0] /* Wrap around */; 
  	const end = pointsToUse[i+2] || pointsToUse[1] /* Wrap around */;
    path += `M${start.x},${start.y} ` /* Move to the start positio */
    path += `Q${pivot.x},${pivot.y} ${end.x},${end.y} `;
  }
	$path.setAttribute('d', path);
  requestAnimationFrame(drawFrame(frameNumber + 1));
}

drawFrame(0)();

let index = 0;
const changePoints = () => {
  pointsToUse = pointsToPickFrom[index];
  index = (index+1) % pointsToPickFrom.length;
};
changePoints();
setInterval(changePoints, changeTime);
setInterval(() => {
  // Generate new set of points to pick from every minute.
  pointsToPickFrom = generatePointsToPickFrom();
}, 60 * 1000);
</script>
<script>
// Registering ServiceWorker
if ( 'serviceWorker' in navigator ) {
  navigator.serviceWorker.register( '/circular-waveform-visualizer/sw.js' ).then(function(registration) {

    // Registration was successful
    console.log( 'ServiceWorker registration successful. Scope: ' + registration.scope )
  }).catch(function(err) {

    // Registration failed with error
    console.log( 'ServiceWorker registration failed. Error: ' + err);
  });
}
</script>
</body>
</html>
